\chapter{Infrastructure}\label{chap:infrastructure}

% WHAT is infrastructure

% WHY is infrastructure (the purpose of it)
%    Importance of automation: builds, testing, deployment
%    Requirements: WHY we spent time doing this

% HOW is infrastructure
%    Tooling!

Broadly, infrastructure tools fit into one or more of four categories:
building, testing, deployment, and task automation.

% TODO: placeholder
\lipsum[1]

\section{Building}

% TODO: placeholder
\lipsum[11]

% Literate configure.ac

\subsection{Pre-processing and cache busting}

% Content hashing case study with autotools

\subsection{On-demand build systems using inotify subsystem}

\subsection{Autotools}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Figure: build-system-flowchart %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{figure}[H]
\centering
\begin{tikzpicture}[auto, thick,
                    scale=0.65, every node/.style={scale=0.65},
                    node distance = 2cm]

  % HTML NODES:
  \node (start) [block] {\textbf{START}};
  \node (more-html) [decision, below of=start] {More HTML targets?};
  \node (html-next) [block, below of=more-html] {Get next HTML target};
  \node (html-modified) [decision, below of=html-next] {Source modified?};
  \node (html-compile) [block, below of=html-modified] {Compile HTML};
  \node (html-update) [block, left of=html-compile] {Update timestamp};

  % HTML EDGES:
  \draw[->] (start) -- (more-html);
  \draw[->] (more-html) -- node {YES} (html-next);
  \draw[->] (html-next) -- (html-modified);
  \draw[->] (html-modified) -- node {YES} (html-compile);
  \draw[->] (html-compile) -- (html-update);
  \draw[->] (html-modified.180) -- node {NO} ++ (-1.65,0);
  \draw[->] (html-update) |- (more-html.180);

  % CSS NODES:
  \node (more-css) [decision, right of=more-html,
                    xshift=6cm] {More CSS targets?};
  \node (css-next) [block, below of=more-css] {Get next CSS target};
  \node (css-modified) [decision, below of=css-next] {Source modified?};
  \node (css-html) [decision, left of=css-modified,
                    xshift=-0.2cm] {HTML modified?};
  \node (css-compile) [block, below of=css-modified] {Compile CSS};
  \node (css-update) [block, left of=css-compile,
                      xshift=-2.4cm] {Update timestamp};
  \node (css-ref) [block, above of=css-update,
                   yshift=3cm] {Update HTML references};

  % CSS EDGES:
  \draw[->] (more-html.0) -- node {NO} ++ (1, 0) -- (more-css);
  \draw[->] (more-css) -- node {YES} (css-next);
  \draw[->] (css-next) -- (css-modified);
  \draw[->] (css-modified) -- node {YES} (css-compile);
  \draw[->] (css-modified) -- node {NO} (css-html);
  \draw[->] (css-compile) -- (css-update);
  \draw[->] (css-update) -- (css-ref);
  \draw[->] (css-ref) |- (more-css);
  \draw[->] (css-html) -- node {NO} ++ (0, 2) |- (more-css);
  \draw[->] (css-html.180) -- node {YES} ++ (-.85cm, 0);

  % JS NODES:
  \node (more-js) [decision, right of=more-css,
                    xshift=6cm] {More JS targets?};
  \node (js-next) [block, below of=more-js] {Get next JS target};
  \node (js-modified) [decision, below of=js-next] {Source modified?};
  \node (js-html) [decision, left of=js-modified,
                    xshift=-0.2cm] {HTML modified?};
  \node (js-compile) [block, below of=js-modified] {Compile JS};
  \node (js-update) [block, left of=js-compile,
                      xshift=-2.4cm] {Update timestamp};
  \node (js-ref) [block, above of=js-update,
                   yshift=3cm] {Update HTML references};
  \node (finish) [block, above of=more-js] {\textbf{FINISH}};

  % JS EDGES:
  \draw[->] (more-css.0) -- node {NO} ++ (1, 0) -- (more-js);
  \draw[->] (more-js) -- (finish);
  \draw[->] (more-js) -- node {YES} (js-next);
  \draw[->] (js-next) -- (js-modified);
  \draw[->] (js-modified) -- node {YES} (js-compile);
  \draw[->] (js-modified) -- node {NO} (js-html);
  \draw[->] (js-compile) -- (js-update);
  \draw[->] (js-update) -- (js-ref);
  \draw[->] (js-ref) |- (more-js);
  \draw[->] (js-html) -- node {NO} ++ (0, 2) |- (more-js);
  \draw[->] (js-html.180) -- node {YES} ++ (-.85cm, 0);
\end{tikzpicture}
\caption[Build system flowchart]{Build system flowchart.}
\label{fig:build-system-flowchart}
\end{figure}

\newpage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Listing: build-javascript %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\lstset{language=make}
\begin{center}
\begin{lstlisting}[label=lst:build-javascript,caption={
      [Autotools Makefile pattern for JavaScript compilation]
      Autotools Makefile pattern for JavaScript compilation, taken
      from \texttt{www/js/Makefile.am}. The conditional variables
      \texttt{ENABLE\_MINI\_JS} and
      \texttt{ENABLE\_CONTENT\_HASHING} are used to control the
      behaviour of the compilation, and are set by passing argument
      flags to the configuration script.}]
# Compilation command
if ENABLE_MINIFY_JS
define compile
    $(JAVA) -jar $(JS_JAR) --js=$1 --js_output_file=$2
endef
else # Disabled minification
define compile
    cat $1 > $2
endef
endif

# JavaScript compilation
$(DEST)/%.js: %.js
    @test -d $(DEST) || { \
        $(MKDIR_P) $(DEST); \
    }
if ENABLE_CONTENT_HASHING
    $(eval CHASH := $(shell $(HASH_BIN) $< | cut -c1-$(HASH_LENGTH)))
    $(eval NAME := $(addsuffix -$(CHASH).js,$(patsubst %.js,%,$@)))
else
    $(eval NAME := $@)
endif
    @test -f $(NAME) || { \
        echo '  JS     $(notdir $(NAME))'; \
        $(call compile,$<,$(NAME)); \
    }
if ENABLE_CONTENT_HASHING
    $(eval TARGET := js\/$(patsubst %.js,%,$<))
    @for h in $(HTML); do \
        sed -ri 's/(<script src=\"(\{\{ *(\w|[_.])+ *\}\})*\/?)$(TARGET)(-[0-9a-f]{$(HASH_LENGTH)})?(\.js\")/\1$(TARGET)-$(CHASH)\5/' $$h; \
    done
endif
\end{lstlisting}
\end{center}


\section{Testing}

% TODO: placeholder
\lipsum[13-14]

\subsection{Branch analysis for test coverage}

% TODO: placeholder
\lipsum[12-16]

% Cloverage

\subsection{Continuous integration}

% TODO: placeholder
\lipsum[18-26]

% Travis CI

\section{Deployment}

% TODO: placeholder
\lipsum[12-24]

% Heroku

\section{Task automation}

% TODO: placeholder
\lipsum[50]

\subsection{dsa}

% TODO: placeholder
\lipsum[35-42]

\subsection{png}

% TODO: placeholder
\lipsum[40-48]

\newpage
\subsection{pipbot}\label{sec:pipbot}

% TODO: placeholder
\lipsum[30]

%%%%%%%%%%%%%%%%%%%%%%%%%
%% Figure: pipbot-logo %%
%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{figure}[H]
\begin{verbatim}
                              ,--.    ,--.
                             ((O ))--((O ))
                           ,'_`--'____`--'_`.
                          _:  ____________  :_
                         | | ||::::::::::|| | |
                         | | ||::::::::::|| | |
                         | | ||::::::::::|| | |
                         |_| |/__________\| |_|
                           |________________|
                        __..-'            `-..__
                     .-| : .----------------. : |-.
                   ,\ || | |\______________/| | || /.
                  /`.\:| | ||  __  __  __  || | |;/,'\
                 :`-._\;.| || '--''--''--' || |,:/_.-':
                 |    :  | || .----------. || |  :    |
                 |    |  | || '--pipbot--' || |  |    |
                 |    |  | ||   _   _   _  || |  |    |
                 :,--.;  | ||  (_) (_) (_) || |  :,--.;
                 (`-'|)  | ||______________|| |  (|`-')
                  `--'   | |/______________\| |   `--'
                         |____________________|
                          `.________________,'
                           (_______)(_______)
                           (_______)(_______)
                           (_______)(_______)
                           (_______)(_______)
                          |        ||        |
                          '--------''--------'
                     Hello there. My name is pipbot.
\end{verbatim}
\caption[The pipbot welcome message]
  {The pipbot welcome message, displayed at the start of interactive sessions.}
\label{fig:pipbot-logo}
\end{figure}

% TODO: placeholder
\lipsum[33-37]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Figure: pipbot-session %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{figure}[H]
\begin{verbatim}
$ pipbot
Hello there. My name is pipbot.
-> burndown 7 days
Comparing `master' against `master'...

  There are 56 new commits on master
  The last commit on master was 5 days, 2 hours ago
-> version
0.6.2
-> start 0.6.3
Summary of actions:
- A new branch release/0.6.3 was created, based on master.
- A new remote branch release/0.6.3 was created on origin.
- Branch release/0.6.3 tracks remote branch release/0.6.3 from origin.
- You are now on branch release/0.6.3.
- The version  number has been bumped to 0.6.3 and committed

Now, start performing release fixes. When done, use:

     pipbot finish 0.6.3

-> exit
Goodbye!
\end{verbatim}
\caption[Example pipbot session]
  {An example pipbot interactive session, in which the user begins a
   new release. User issued commands begin with the prefix
   ``\texttt{-> }''. First, the user requests a burndown of the
   repository activity over the past week; then they request the
   current version, and begin a new release with the version number
   \texttt{0.6.3}.}
\label{fig:pipbot-session}
\end{figure}

% TODO: placeholder
\lipsum[40-47]
